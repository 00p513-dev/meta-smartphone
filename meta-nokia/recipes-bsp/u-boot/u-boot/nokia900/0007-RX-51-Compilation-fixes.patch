From 1f9ec51a6787312511d79808827a147271f68a5c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pali=20Roh=C3=A1r?= <pali.rohar@gmail.com>
Date: Fri, 16 Sep 2011 17:50:58 +0200
Subject: [PATCH 07/16] RX-51: Compilation fixes

Signed-off-by: Martin Jansa <Martin.Jansa@gmail.com>
---
 arch/arm/cpu/armv7/start.S   |    2 +-
 board/nokia/rx51/rx51.c      |   29 +++++++++++++---------
 include/configs/nokia_rx51.h |   53 ++++++++++++++++++++++-------------------
 3 files changed, 46 insertions(+), 38 deletions(-)

diff --git a/arch/arm/cpu/armv7/start.S b/arch/arm/cpu/armv7/start.S
index 3919537..efcc4c1 100644
--- a/arch/arm/cpu/armv7/start.S
+++ b/arch/arm/cpu/armv7/start.S
@@ -145,7 +145,7 @@ IRQ_STACK_START_IN:
 
 reset:
 	bl	save_boot_params
-#if (CONFIG_CHAINLOADER)
+#ifdef CONFIG_CHAINLOADER
 	/* Copy u-boot.bin to TEXT_BASE if it isn't already there. */
 	adr	r0, _start		@ Where u-boot.bin was loaded
 	str	r0, _INIT_LOADADDR
diff --git a/board/nokia/rx51/rx51.c b/board/nokia/rx51/rx51.c
index e8f26f9..079a9ab 100644
--- a/board/nokia/rx51/rx51.c
+++ b/board/nokia/rx51/rx51.c
@@ -1,4 +1,7 @@
 /*
+ * (C) Copyright 2011
+ * Pali Rohár <pali.rohar@gmail.com>
+ *
  * (C) Copyright 2010
  * Alistair Buxton <a.j.buxton@gmail.com>
  *
@@ -38,7 +41,7 @@
 #include <asm/io.h>
 #include <asm/arch/mux.h>
 #include <asm/arch/sys_proto.h>
-#include <asm/arch/gpio.h>
+#include <asm/omap_gpio.h>
 #include <asm/mach-types.h>
 #include "rx51.h"
 
@@ -47,14 +50,14 @@ GraphicDevice gdev;
 extern unsigned int _INIT_LOADADDR;
 extern unsigned int _INIT_ATAGADDR;
 
+DECLARE_GLOBAL_DATA_PTR;
+
 /*
  * Routine: board_init
  * Description: Early hardware init.
  */
 int board_init(void)
 {
-	DECLARE_GLOBAL_DATA_PTR;
-
 	gpmc_init(); /* in SRAM or SDRAM, finish GPMC */
 	/* board id for Linux */
 	gd->bd->bi_arch_number = MACH_TYPE_NOKIA_RX51;
@@ -95,8 +98,7 @@ int misc_init_r(void)
 	setenv("init_atagaddr", buf);
 #endif
 
-	// set environment variable slide_sw
-	// if keyboard slide is open/close
+	/* set environment variable slide_sw if keyboard slide is open/close */
 	omap_set_gpio_direction(71, 1);
 	unsigned val = omap_get_gpio_datain(71);
 	omap_free_gpio(71);
@@ -122,7 +124,7 @@ void set_muxconf_regs(void)
  * TWL4030 keypad handler for cfb_console
  */
 
-char keymap[] = {
+static const char keymap[] = {
 	/* normal */
 	'q',  'o',  'p',  ',', '\b',    0,  'a',  's',
 	'w',  'd',  'f',  'g',  'h',  'j',  'k',  'l',
@@ -143,11 +145,11 @@ char keymap[] = {
 	'8',    0,    0,    0,    0,    0,    0,    0,
 };
 
-u8 keys[8];
-u8 old_keys[8] = {0, 0, 0, 0, 0, 0, 0, 0};
+static u8 keys[8];
+static u8 old_keys[8] = {0, 0, 0, 0, 0, 0, 0, 0};
 #define KEYBUF_SIZE 4
-u8 keybuf[KEYBUF_SIZE];
-u8 keybuf_head = 0, keybuf_tail = 0;
+static u8 keybuf[KEYBUF_SIZE];
+static u8 keybuf_head = 0, keybuf_tail = 0;
 
 int rx51_kp_init(void)
 {
@@ -183,7 +185,7 @@ int rx51_kp_init(void)
 	return ret;
 }
 
-void rx51_kp_fill(u8 k, u8 mods)
+static void rx51_kp_fill(u8 k, u8 mods)
 {
 	if (mods & 2) { /* fn */
 		k = keymap[k+64];
@@ -209,7 +211,7 @@ int rx51_kp_tstc(void)
 	u8 mods;
 
 	/* twl4030 remembers up to 2 events */
-	for (i = 0; i < 2; i++)	{
+	for (i = 0; i < 2; i++) {
 
 		/* check interrupt register for events */
 		twl4030_i2c_read_u8(TWL4030_CHIP_KEYPAD, &intr,
@@ -237,8 +239,11 @@ int rx51_kp_tstc(void)
 						rx51_kp_fill((c*8)+r, mods);
 					dk = dk >> 1;
 				}
+
 			}
+
 		}
+
 	}
 	return (KEYBUF_SIZE + keybuf_tail - keybuf_head)%KEYBUF_SIZE;
 }
diff --git a/include/configs/nokia_rx51.h b/include/configs/nokia_rx51.h
index e16cc64..ab7ddea 100644
--- a/include/configs/nokia_rx51.h
+++ b/include/configs/nokia_rx51.h
@@ -1,4 +1,7 @@
 /*
+ * (C) Copyright 2011
+ * Pali Rohár <pali.rohar@gmail.com>
+ *
  * (C) Copyright 2010
  * Alistair Buxton <a.j.buxton@gmail.com>
  *
@@ -36,14 +39,14 @@
  * High Level Configuration Options
  */
 
-#define CONFIG_ARMV7		1	/* This is an ARM V7 CPU core */
-#define CONFIG_OMAP		1	/* in a TI OMAP core */
-#define CONFIG_OMAP34XX		1	/* which is a 34XX */
-#define CONFIG_OMAP3430		1	/* which is in a 3430 */
-#define CONFIG_CHAINLOADER	1	/* Loaded by NOLO */
-#define CONFIG_L2_OFF		1	/* kernel won't boot if l2 enabled */
-					/* (old u-boot tried but failed to */
-					/*  enable it, due to a bug.)      */
+#define CONFIG_ARMV7		/* This is an ARM V7 CPU core */
+#define CONFIG_OMAP		/* in a TI OMAP core */
+#define CONFIG_OMAP34XX		/* which is a 34XX */
+#define CONFIG_OMAP3430		/* which is in a 3430 */
+#define CONFIG_CHAINLOADER	/* Loaded by NOLO */
+#define CONFIG_L2_OFF		/* kernel won't boot if l2 enabled */
+				/* (old u-boot tried but failed to */
+				/*  enable it, due to a bug.)      */
 
 /* It doesn't really matter what we set this to. NOLO will load u-boot.bin
  * in a random place anyway, and we have to copy.
@@ -58,8 +61,8 @@
 /*
  * Display CPU and Board information
  */
-#define CONFIG_DISPLAY_CPUINFO		1
-#define CONFIG_DISPLAY_BOARDINFO	1
+#define CONFIG_DISPLAY_CPUINFO
+#define CONFIG_DISPLAY_BOARDINFO
 
 /* Clock Defines */
 #define V_OSCK			26000000	/* Clock output from T2 */
@@ -69,8 +72,8 @@
 #define CONFIG_MISC_INIT_R
 #define CONFIG_SKIP_LOWLEVEL_INIT		/* NOLO set everything up */
 
-#define CONFIG_CMDLINE_TAG		1	/* enable passing of ATAGs */
-#define CONFIG_SETUP_MEMORY_TAGS	1
+#define CONFIG_CMDLINE_TAG			/* enable passing of ATAGs */
+#define CONFIG_SETUP_MEMORY_TAGS
 #define CONFIG_INITRD_TAG		1
 #define CONFIG_REVISION_TAG		1
 
@@ -107,24 +110,24 @@
 #define CONFIG_BAUDRATE			115200
 #define CONFIG_SYS_BAUDRATE_TABLE	{4800, 9600, 19200, 38400, 57600,\
 					115200}
-#define CONFIG_MMC			1
-#define CONFIG_OMAP3_MMC		1
-#define CONFIG_DOS_PARTITION		1
+#define CONFIG_MMC
+#define CONFIG_OMAP3_MMC
+#define CONFIG_DOS_PARTITION
 
 /* DDR - I use Micron DDR */
-#define CONFIG_OMAP3_MICRON_DDR		1
+#define CONFIG_OMAP3_MICRON_DDR
 
 /* USB - broken */
-#define CONFIG_MUSB_UDC			1
-#define CONFIG_USB_OMAP3		1
-#define CONFIG_TWL4030_USB		1
+#define CONFIG_MUSB_UDC
+#define CONFIG_USB_OMAP3
+#define CONFIG_TWL4030_USB
 
 /* USB device configuration - broken */
-#define CONFIG_USB_DEVICE		1
+#define CONFIG_USB_DEVICE
 /* FIXME: usbtty breaks maemo pr1.2 kernel booting
-#define CONFIG_USB_TTY			1
+#define CONFIG_USB_TTY
 */
-#define CONFIG_SYS_CONSOLE_IS_IN_ENV	1
+#define CONFIG_SYS_CONSOLE_IS_IN_ENV
 
 /* commands to include */
 #include <config_cmd_default.h>
@@ -144,7 +147,7 @@
 #undef CONFIG_CMD_NFS		/* NFS support			*/
 
 #define CONFIG_SYS_NO_FLASH
-#define CONFIG_HARD_I2C			1
+#define CONFIG_HARD_I2C
 #define CONFIG_SYS_I2C_SPEED		100000
 #define CONFIG_SYS_I2C_SLAVE		1
 #define CONFIG_SYS_I2C_BUS		0
@@ -235,7 +238,7 @@ int rx51_kp_getc(void);
 		"setenv mmcpart 0:4; run trymmc; " \
 	"fi; run noloboot;"
 
-#define CONFIG_AUTO_COMPLETE		1
+#define CONFIG_AUTO_COMPLETE
 /*
  * Miscellaneous configurable options
  */
@@ -293,7 +296,7 @@ int rx51_kp_getc(void);
  * FLASH and environment organization
  */
 
-#define CONFIG_ENV_IS_NOWHERE	1
+#define CONFIG_ENV_IS_NOWHERE
 
 #define CONFIG_SYS_SDRAM_BASE		PHYS_SDRAM_1
 #define CONFIG_SYS_INIT_RAM_ADDR	0x4020f800
-- 
1.7.6.1

